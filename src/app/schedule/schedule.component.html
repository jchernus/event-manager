<h1>Schedule</h1>

<ul class="nav nav-pills">
	<li class="nav-item">
    <a class="nav-link" [class.active]="viewMode==250" (click)="changeViewMode(250)">Heavyweight</a>
  </li>
	<li class="nav-item">
    <a class="nav-link" [class.active]="viewMode==30" (click)="changeViewMode(30)">Sportsman</a>
  </li>
	<li class="nav-item">
    <a class="nav-link" [class.active]="viewMode==15" (click)="changeViewMode(15)">Dogeweight</a>
  </li>
</ul>

<div *ngIf="auth.isAdmin(auth.user | async)">
  <h4> Admin Controls</h4>
  <button class="btn btn-info" (click)="openScheduleFightModal(scheduleFightModal)">Schedule Fight</button>
  <button class="btn btn-info" (click)="openScheduleBreakModal(scheduleBreakModal)">Schedule Break</button>
  <br>
  <br>
</div>

<!-- <h2>Upcoming Matches</h2> -->

<p *ngIf="currentlyFighting; else noCurrentFight">
  Fight in progress between {{currentlyFighting.redSquare}} and {{currentlyFighting.blueSquare}}
</p>
<ng-template #noCurrentFight><p>
  Noone is currently fighting
</p></ng-template>

<div>
  <table class="table table-striped"> 
    <thead>
      <tr>
        <th>No.</th>
        <th>Red Square</th>
        <th>Blue Square</th>
        <!-- <th>Timestamp</th> -->
        <th *ngIf="auth.isAdmin(auth.user | async)">Controls</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let match of schedule | async as matches; let i = index; first as isFirst; last as isLast;">
        <tr *ngIf="match.breakDuration !== undefined; else isFight">
          <td class="info">{{i+1}}</td>
          <td  class="info"colspan="2" align="center">
            {{match.breakDuration}} Minute Break
          </td>
          <td class="info" *ngIf="auth.isAdmin(auth.user | async)">
            <button 
              [disabled]="isFirst"
              (click)="scheduleService.moveMatch(match.id, match.timestamp, matches[i-1].id, matches[i-1].timestamp)"
              type="button" 
              id="moveUp"
              class="btn"
              [class.btn-outline-info]="! isFirst"
              [class.btn-outline-secondary]="isFirst">
              &#9650;
            </button>
            <button 
              [disabled]="isLast"
              (click)="scheduleService.moveMatch(match.id, match.timestamp, matches[i+1].id, matches[i+1].timestamp)"
              type="button" 
              id="moveDown"
              class="btn"
              [class.btn-outline-info]="! isLast"
              [class.btn-outline-secondary]="isLast">
              &#9660;
            </button>
            <button 
              (click)="scheduleService.deleteBreak(match.id)"
              type="button" 
              class="btn btn-outline-danger">
                Delete Break
            </button>
          </td>
        </tr>
        <ng-template #isFight>
        <!-- <ng-container *ngIf="match.redSquare !== undefined"> -->
        <tr>
          <td>{{i+1}}</td>
          <td>{{match.redSquare}}</td>
          <td>{{match.blueSquare}}</td>
          <!-- <td>{{match.timestamp.toDate() | date:'medium'}}</td> -->
          <td *ngIf="auth.isAdmin(auth.user | async)">
            <button 
              [disabled]="isFirst"
              (click)="scheduleService.moveMatch(match.id, match.timestamp, matches[i-1].id, matches[i-1].timestamp)"
              type="button" 
              id="moveUp"
              class="btn"
              [class.btn-outline-info]="! isFirst"
              [class.btn-outline-secondary]="isFirst">
              &#9650;
            </button>
            <button 
              [disabled]="isLast"
              (click)="scheduleService.moveMatch(match.id, match.timestamp, matches[i+1].id, matches[i+1].timestamp)"
              type="button" 
              id="moveDown"
              class="btn"
              [class.btn-outline-info]="! isLast"
              [class.btn-outline-secondary]="isLast">
              &#9660;
            </button>
            <button 
              (click)="scheduleService.deleteMatch(match.redSquare, match.blueSquare, match.id)"  
              type="button" 
              class="btn btn-outline-danger">
                Delete Match
            </button>
          </td>
        </tr>
        <!-- </ng-container> -->
        </ng-template>
      </ng-container>
    </tbody>
  </table>
</div>

<ng-template #scheduleFightModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="schedule-fight-modal">Schedule Fight</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form [formGroup]="scheduleForm" (ngSubmit)="scheduleFight()">
      <div class="form-row align-items-center">
        <div class="form-group">
          <label for="red">Red Square:</label>
          <select
            required
            [(ngModel)]="redBot"
            name="red"
            formControlName="red"
            id=""
            type="select"
            class="form-control"
            class="custom-select mr-sm-2">
            <option *ngFor="let robot of (robots | async)" value="{{robot.name}}">{{robot.name}}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="blue">Blue Square:</label>
          <select
            required
            [(ngModel)]="blueBot" 
            name="blue"
            formControlName="blue"
            id=""
            type="select"
            class="form-control"
            class="custom-select mr-sm-2">
            <option *ngFor="let robot of (robots | async)" value="{{robot.name}}">{{robot.name}}</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary">Add to Schedule</button>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" (click)="modal.dismiss()">Exit</button>
  </div>
</ng-template>

<ng-template #scheduleBreakModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="schedule-break-modal">Schedule Break</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
  <form [formGroup]="breakForm" (ngSubmit)="scheduleBreak()">
      <div class="form-row align-items-center">
        <div class="form-group">
          <label for="breakTime">Duration:</label>
          <select
            required
            [(ngModel)]="breakDuration"
            name="breakTime"
            formControlName="breakTime"
            id=""
            type="select"
            class="form-control"
            class="custom-select mr-sm-2">
            <!-- <option *ngFor="let duration of durations" value="{{duration}}">{{duration}} minutes</option> -->
            <option value="5">5 minutes</option>
            <option value="10">10 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">60 minutes</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary">Add to Schedule</button>
    </form>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" (click)="modal.dismiss()">Exit</button>
  </div>
</ng-template>